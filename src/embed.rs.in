use mlua::prelude::*;
use rust_embed::RustEmbed;
use std::str;

/// Embed everything that would otherwise be installed to datadir
#[derive(RustEmbed)]
#[folder = "."]
// @INCLUDE_EMDED_INCLUDES@ -- this marker line gets replaced by a list of includes
#[exclude = "*"]
pub struct SileModules;

pub fn inject_embeded_loader (lua: &Lua) {
  let package: LuaTable = lua.globals().get("package").unwrap();

  let loaders: LuaValue = package.get("loaders").unwrap();
  if let LuaValue::Table(loaders) = loaders {
    dbg!(loaders.clone());

    loaders.push(LuaFunction::wrap(|lua, module: String| {
      dbg!(module.clone());
      let embeded = SileModules::get(&module);
      match embeded {
	Some(module) => {
	  return LuaFunction::wrap(move |lua, ()| {
	    let data = str::from_utf8(module.data.as_ref()).expect("Embeded content is not valid UTF-8");
	    lua.create_string(data)
	  }).into_lua(lua)
	},
	None => format!("Module {module} is not embeded in Rust binary").into_lua(lua)
      }
    })).unwrap();

    dbg!(loaders.clone());

    lua.load(r#"print("fizzle", require("core/version.lua"))"#).exec().unwrap();
  }

  let searchers: LuaValue = package.get("searchers").unwrap();
  if let LuaValue::Table(searchers) = searchers {
    dbg!(searchers);
  }
}
